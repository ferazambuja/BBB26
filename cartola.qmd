---
title: "BBB 26 â€” Cartola"
subtitle: "Sistema de pontuaÃ§Ã£o Cartola BBB"
lang: pt-BR
format:
  html:
    code-tools: false
execute:
  echo: false
  warning: false
---

```{python}
#| label: setup
#| include: false

import json
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from pathlib import Path
from collections import defaultdict
import sys

sys.path.append(str(Path("scripts").resolve()))
from data_utils import (
    require_clean_manual_events, setup_bbb_dark_theme, GROUP_COLORS,
    CARTOLA_POINTS, POINTS_LABELS, POINTS_EMOJI, get_week_number,
)

require_clean_manual_events()
setup_bbb_dark_theme()

def contrast_color(hex_color):
    hex_color = hex_color.lstrip('#')
    if len(hex_color) != 6:
        return '#fff'
    r, g, b = (int(hex_color[i:i+2], 16) for i in (0, 2, 4))
    luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255
    return '#000' if luminance > 0.6 else '#fff'

# Load precomputed Cartola data
with open("data/derived/cartola_data.json") as f:
    cartola = json.load(f)

leaderboard = cartola["leaderboard"]
stats = cartola["stats"]
n_weeks = cartola["_metadata"]["n_weeks"]
weekly_points = cartola["weekly_points"]

n_with_points = stats["n_with_points"]
n_active = stats["n_active"]
total_positive = stats["total_positive"]
total_negative = stats["total_negative"]
seen_roles = stats["seen_roles"]
current_roles = stats["current_roles"]
leader = leaderboard[0] if leaderboard else None

# Build participant info / avatars / colors from leaderboard
PARTICIPANT_INFO = {}
AVATARS = {}
for entry in leaderboard:
    name = entry['name']
    PARTICIPANT_INFO[name] = {
        'grupo': entry['grupo'],
        'avatar': entry['avatar'],
        'active': entry['active'],
    }
    if entry['avatar']:
        AVATARS[name] = entry['avatar']

all_participants = sorted(PARTICIPANT_INFO.keys())
palette = (
    px.colors.qualitative.Plotly + px.colors.qualitative.D3 +
    px.colors.qualitative.Set2 + px.colors.qualitative.Bold
)
participant_colors = {name: palette[i % len(palette)] for i, name in enumerate(all_participants)}

# Reconstruct all_points from weekly_points (for evolution chart + weekly tabs)
all_points = defaultdict(lambda: defaultdict(list))
for week_str, participants in weekly_points.items():
    week = int(week_str)
    for participant, events in participants.items():
        for evt_data in events:
            all_points[participant][week].append(tuple(evt_data))

# Load manual events (for weekly notes / Big Fone display)
manual_events_path = Path('data/manual_events.json')
if manual_events_path.exists():
    with open(manual_events_path) as f:
        manual_events = json.load(f)
else:
    manual_events = {'participants': {}, 'weekly_events': [], 'special_events': [], 'power_events': [], 'cartola_points_log': []}

weekly_data = manual_events.get('weekly_events', [])
```

```{python}
#| label: destaques
#| output: asis

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DESTAQUES - Key highlights at the top (matching index.qmd style)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

highlights = []

if leader and leader['total'] != 0:
    grupo = leader['grupo']
    highlights.append(f"ğŸ† **{leader['name']}** ({grupo}) lidera com **{leader['total']:+d}** pontos")

# Current roles from precomputed data
if current_roles.get('LÃ­der'):
    name = current_roles['LÃ­der']
    highlights.append(f"ğŸ‘‘ LÃ­der atual: **{name}** (+80 pts)")
if current_roles.get('Anjo'):
    name = current_roles['Anjo']
    highlights.append(f"ğŸ˜‡ Anjo: **{name}** (+45 pts)")
if current_roles.get('Monstro'):
    names = ', '.join(current_roles['Monstro'])
    highlights.append(f"ğŸ‘¹ Monstro: **{names}** (-10 pts)")
if current_roles.get('ParedÃ£o'):
    names = ', '.join(current_roles['ParedÃ£o'])
    highlights.append(f"ğŸ—³ï¸ No ParedÃ£o: **{names}** (-15 pts)")

# Worst score
bottom = [p for p in leaderboard if p['total'] < 0]
if bottom:
    worst = min(bottom, key=lambda x: x['total'])
    status = manual_events.get('participants', {}).get(worst['name'], {}).get('status', '')
    status_text = f" ({status})" if status else ""
    highlights.append(f"ğŸ“‰ Pior pontuaÃ§Ã£o: **{worst['name']}** ({worst['total']:+d}){status_text}")

if highlights:
    print(f'''
<div style="background: #2a2a2a; border-left: 4px solid #2ecc71; border-radius: 8px; padding: 0.8rem 1rem; margin: 1rem 0;">
<div style="font-weight: 700; margin-bottom: 0.5rem;">Destaques Cartola â€” Semana {n_weeks}</div>
<ul style="margin: 0; padding-left: 1.2rem;">
''')
    for h in highlights:
        print(f"<li>{h}</li>")
    print("</ul></div>")
```

```{python}
#| label: kpi-boxes
#| output: asis

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KPI Value Boxes (matching index.qmd style)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

n_lideres = len(seen_roles.get('LÃ­der', []))
n_anjos = len(seen_roles.get('Anjo', []))
n_monstros = len(seen_roles.get('Monstro', []))

print(f'''
<div style="display: flex; flex-wrap: wrap; gap: 0.8rem; margin: 1.5rem 0;">

<div style="flex: 1 1 150px; min-width: 120px; background: linear-gradient(135deg, #f39c12 0%, #d68910 100%); border-radius: 10px; padding: 1rem; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.3);">
<div style="font-size: 2rem; font-weight: bold; color: #fff;">Sem {n_weeks}</div>
<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); text-transform: uppercase;">ğŸ“… Semana Atual</div>
</div>

<div style="flex: 1 1 150px; min-width: 120px; background: linear-gradient(135deg, #f1c40f 0%, #d4ac0d 100%); border-radius: 10px; padding: 1rem; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.3);">
<div style="font-size: 2rem; font-weight: bold; color: #fff;">{n_lideres}</div>
<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); text-transform: uppercase;">ğŸ‘‘ LÃ­deres</div>
</div>

<div style="flex: 1 1 150px; min-width: 120px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 10px; padding: 1rem; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.3);">
<div style="font-size: 2rem; font-weight: bold; color: #fff;">{n_anjos}</div>
<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); text-transform: uppercase;">ğŸ˜‡ Anjos</div>
</div>

<div style="flex: 1 1 150px; min-width: 120px; background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border-radius: 10px; padding: 1rem; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.3);">
<div style="font-size: 2rem; font-weight: bold; color: #fff;">{total_positive:+d}</div>
<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); text-transform: uppercase;">ğŸ“ˆ Pts Positivos</div>
</div>

<div style="flex: 1 1 150px; min-width: 120px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border-radius: 10px; padding: 1rem; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.3);">
<div style="font-size: 2rem; font-weight: bold; color: #fff;">{total_negative:+d}</div>
<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); text-transform: uppercase;">ğŸ“‰ Pts Negativos</div>
</div>

</div>

<p class="text-muted small" style="margin-top: 0.3rem;">Pontos calculados automaticamente da API (LÃ­der, Anjo, Monstro, ParedÃ£o, VIP) + eventos manuais.</p>
''')
```

# Ranking Cartola {#ranking}

PontuaÃ§Ã£o acumulada de todos os participantes. Cores representam cada participante.

```{python}
#| label: leaderboard-cards
#| output: asis

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Leaderboard with participant cards (matching Perfis Individuais style)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Show all participants with points + top 5 with 0
with_points = [p for p in leaderboard if p['total'] != 0]
zero_points = [p for p in leaderboard if p['total'] == 0 and p['active']][:5]
display_list = with_points + zero_points

if display_list:
    print('<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1rem; margin: 1.5rem 0;">')

    for i, p in enumerate(display_list):
        rank = i + 1 if p['total'] != 0 else 'â€”'
        participant_color = participant_colors.get(p['name'], '#666')
        badge_text_color = contrast_color(participant_color)
        avatar_url = p['avatar'] or ''
        status_badge = ''

        # Determine card border color based on ranking/status
        if not p['active']:
            border_color = '#6c757d'  # Gray for exited
            status_text = manual_events.get('participants', {}).get(p['name'], {}).get('status', 'saiu')
            status_badge = f'<span style="background: #6c757d; color: #fff; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; text-transform: uppercase; margin-left: 0.5rem;">{status_text}</span>'
        elif rank == 1:
            border_color = '#f1c40f'  # Gold for 1st
        elif isinstance(rank, int) and rank <= 3:
            border_color = '#27ae60'  # Green for top 3
        elif p['total'] < 0:
            border_color = '#e74c3c'  # Red for negative
        elif p['total'] > 0:
            border_color = '#3498db'  # Blue for positive
        else:
            border_color = '#444'  # Dark for zero

        # Format events for this participant (grouped by type)
        events_html = ''
        if p['events']:
            event_stats = defaultdict(lambda: {'count': 0, 'total': 0})
            for evt in p['events']:
                event_stats[evt['event']]['count'] += 1
                event_stats[evt['event']]['total'] += evt['points']

            event_tags = []
            for evt_type, stats_item in sorted(event_stats.items(), key=lambda x: -abs(x[1]['total'])):
                emoji = POINTS_EMOJI.get(evt_type, 'â€¢')
                label = POINTS_LABELS.get(evt_type, evt_type)
                total_pts = stats_item['total']
                count = stats_item['count']
                pts_color = '#27ae60' if total_pts > 0 else '#e74c3c'
                count_prefix = f"{count}x " if count > 1 else ""
                event_tags.append(
                    f'<span style="background: #383838; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin: 0.15rem; display: inline-block;">'
                    f'{count_prefix}{emoji} {label} <span style="color: {pts_color}; font-weight: bold;">{total_pts:+d}</span></span>'
                )
            events_html = f'<div style="margin-top: 0.5rem; line-height: 1.8;">{"".join(event_tags)}</div>'

        # Points display
        pts_color = '#27ae60' if p['total'] > 0 else ('#e74c3c' if p['total'] < 0 else '#888')
        rank_display = f"{rank}Âº" if isinstance(rank, int) else rank

        print(f'''
<div style="background: #2a2a2a; border-radius: 12px; border-left: 5px solid {border_color}; padding: 1rem; display: flex; gap: 1rem; align-items: flex-start;">
<div style="flex-shrink: 0; position: relative;">
''')
        if avatar_url:
            print(f'<img src="{avatar_url}" alt="{p["name"]}" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid {participant_color}; object-fit: cover;">')
        else:
            print(f'<div style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid {participant_color}; background: #444; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #888;">?</div>')

        # Rank badge
        if isinstance(rank, int) and rank <= 3:
            rank_emoji = 'ğŸ¥‡' if rank == 1 else ('ğŸ¥ˆ' if rank == 2 else 'ğŸ¥‰')
            print(f'<div style="position: absolute; bottom: -5px; right: -5px; font-size: 1.2rem;">{rank_emoji}</div>')

        print(f'''
</div>
<div style="flex: 1; min-width: 0;">
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.3rem;">
<div>
<span style="font-weight: bold; color: #fff; font-size: 1.1rem;">{rank_display} {p['name']}</span>
<span style="background: {participant_color}; color: {badge_text_color}; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">{p['grupo']}</span>
{status_badge}
</div>
<div style="font-size: 1.5rem; font-weight: bold; color: {pts_color};">{p['total']:+d}</div>
</div>
{events_html}
</div>
</div>
''')

    print('</div>')
else:
    print('<p class="text-muted">Nenhum participante encontrado.</p>')
```

PontuaÃ§Ã£o acumulada ao longo das semanas.

```{python}
#| label: evolution-chart

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Evolution chart (matching trajetoria.qmd style)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cumulative_evolution = cartola.get("cumulative_evolution", [])

if cumulative_evolution:
    df = pd.DataFrame(cumulative_evolution)
    df.rename(columns={"week": "Semana", "name": "Participante", "cumulative_points": "Pontos"}, inplace=True)

    # Final scores for legend ordering
    final_scores = df.groupby('Participante')['Pontos'].last().to_dict()
    sorted_participants = sorted(final_scores.keys(), key=lambda x: -final_scores[x])

    fig = go.Figure()

    for name in sorted_participants:
        df_p = df[df['Participante'] == name].sort_values('Semana')
        if df_p.empty:
            continue

        color = participant_colors.get(name, '#666')
        final_pts = final_scores[name]

        fig.add_trace(go.Scatter(
            x=df_p['Semana'],
            y=df_p['Pontos'],
            mode='lines+markers',
            name=f"{name} ({final_pts:+d})",
            line=dict(color=color, width=2),
            marker=dict(size=10, color=color),
            hovertemplate=f'{name}<br>Semana %{{x}}: %{{y:+d}} pts<extra></extra>',
        ))

    fig.update_layout(
        title="EvoluÃ§Ã£o da PontuaÃ§Ã£o Cartola",
        xaxis_title="Semana",
        yaxis_title="Pontos Acumulados",
        xaxis=dict(tickmode='linear', tick0=1, dtick=1),
        yaxis=dict(zeroline=True, zerolinecolor='rgba(255,255,255,0.3)', zerolinewidth=1),
        height=500,
        hovermode='x unified',
        legend=dict(font=dict(size=10)),
    )

    fig.show()
else:
    print("*Dados insuficientes para gerar o grÃ¡fico de evoluÃ§Ã£o.*")
```

# Semanas {#semanas}

Detalhamento semanal: papÃ©is e pontuaÃ§Ãµes detectados da API.

```{python}
#| label: weekly-tabs
#| output: asis

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Weekly breakdown in tabset (matching trajetoria.qmd style)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if n_weeks > 0:
    print('::: {.panel-tabset}\n')
    for week in range(1, n_weeks + 1):
        # Get manual week info if available (for Big Fone, notes, etc.)
        week_info = next((w for w in weekly_data if w.get('week') == week), None)

        print(f'## Semana {week}\n')

        # Extract roles from auto-detected points (all_points)
        week_roles = {'LÃ­der': set(), 'Anjo': set(), 'Monstro': set(), 'Imune': set()}
        for participant, weeks_data in all_points.items():
            if week in weeks_data:
                for event, pts, date in weeks_data[week]:
                    if event == 'lider':
                        week_roles['LÃ­der'].add(participant)
                    elif event == 'anjo':
                        week_roles['Anjo'].add(participant)
                    elif event == 'monstro':
                        week_roles['Monstro'].add(participant)
                    elif event == 'imunizado':
                        week_roles['Imune'].add(participant)

        # Role cards
        lider = ', '.join(sorted(week_roles['LÃ­der'])) or 'â€”'
        anjo = ', '.join(sorted(week_roles['Anjo'])) or 'â€”'
        monstro = ', '.join(sorted(week_roles['Monstro'])) or 'â€”'
        imune = ', '.join(sorted(week_roles['Imune'])) or 'â€”'

        lider_avatar = AVATARS.get(list(week_roles['LÃ­der'])[0], '') if week_roles['LÃ­der'] else ''
        anjo_avatar = AVATARS.get(list(week_roles['Anjo'])[0], '') if week_roles['Anjo'] else ''
        imune_avatar = AVATARS.get(list(week_roles['Imune'])[0], '') if week_roles['Imune'] else ''
        monstro_avatar = AVATARS.get(list(week_roles['Monstro'])[0], '') if week_roles['Monstro'] else ''

        print(f'''
<div style="display: flex; flex-wrap: wrap; gap: 1rem; margin: 1rem 0;">

<div style="flex: 1 1 180px; min-width: 160px; background: #2a2a2a; border-radius: 10px; border-left: 4px solid #f1c40f; padding: 1rem; display: flex; align-items: center; gap: 0.8rem;">
''')
        if lider_avatar and lider != 'â€”':
            print(f'<img src="{lider_avatar}" style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid #f1c40f; object-fit: cover;">')
        print(f'''
<div>
<div style="color: #f1c40f; font-size: 0.75rem; text-transform: uppercase;">ğŸ‘‘ LÃ­der</div>
<div style="font-weight: bold; color: #fff; font-size: 1.1rem;">{lider}</div>
<div style="color: #27ae60; font-size: 0.85rem; font-weight: bold;">+80 pts</div>
</div>
</div>

<div style="flex: 1 1 180px; min-width: 160px; background: #2a2a2a; border-radius: 10px; border-left: 4px solid #3498db; padding: 1rem; display: flex; align-items: center; gap: 0.8rem;">
''')
        if anjo_avatar and anjo != 'â€”':
            print(f'<img src="{anjo_avatar}" style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid #3498db; object-fit: cover;">')
        print(f'''
<div>
<div style="color: #3498db; font-size: 0.75rem; text-transform: uppercase;">ğŸ˜‡ Anjo</div>
<div style="font-weight: bold; color: #fff; font-size: 1.1rem;">{anjo}</div>
<div style="color: #27ae60; font-size: 0.85rem; font-weight: bold;">+45 pts</div>
</div>
</div>

<div style="flex: 1 1 180px; min-width: 160px; background: #2a2a2a; border-radius: 10px; border-left: 4px solid #9b59b6; padding: 1rem; display: flex; align-items: center; gap: 0.8rem;">
''')
        if imune_avatar and imune != 'â€”':
            print(f'<img src="{imune_avatar}" style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid #9b59b6; object-fit: cover;">')
        print(f'''
<div>
<div style="color: #9b59b6; font-size: 0.75rem; text-transform: uppercase;">ğŸ›¡ï¸ Imune</div>
<div style="font-weight: bold; color: #fff; font-size: 1.1rem;">{imune}</div>
<div style="color: #27ae60; font-size: 0.85rem; font-weight: bold;">+30 pts</div>
</div>
</div>

<div style="flex: 1 1 180px; min-width: 160px; background: #2a2a2a; border-radius: 10px; border-left: 4px solid #e74c3c; padding: 1rem;">
<div style="display: flex; align-items: center; gap: 0.8rem;">
''')
        if monstro_avatar and monstro != 'â€”':
            print(f'<img src="{monstro_avatar}" style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid #e74c3c; object-fit: cover;">')
        print(f'''
<div>
<div style="color: #e74c3c; font-size: 0.75rem; text-transform: uppercase;">ğŸ‘¹ Monstro</div>
<div style="font-weight: bold; color: #fff; font-size: 1.1rem;">{monstro}</div>
<div style="color: #e74c3c; font-size: 0.85rem; font-weight: bold;">-10 pts</div>
</div>
</div>

</div>
''')

        # Special events from manual data
        if week_info:
            special_events = []
            raw_bf = week_info.get('big_fone')
            bf_list = raw_bf if isinstance(raw_bf, list) else ([raw_bf] if isinstance(raw_bf, dict) else [])
            for bf in bf_list:
                if isinstance(bf, dict) and bf.get('atendeu'):
                    special_events.append(f"ğŸ“ **Big Fone**: {bf.get('atendeu', '?')} atendeu â€” {bf.get('consequencia', '')}")
            if week_info.get('caixas_surpresa'):
                cs = week_info['caixas_surpresa']
                special_events.append(f"ğŸ **Caixas-Surpresa**: {cs.get('resultado', '')}")
            if week_info.get('notes'):
                special_events.append(f"ğŸ“ {week_info['notes']}")

            if special_events:
                print('\n**Eventos especiais:**\n')
                for se in special_events:
                    print(f"- {se}")
                print()

        # All points this week (from API + manual)
        week_points_list = []
        for participant in all_points:
            if week in all_points[participant]:
                events = all_points[participant][week]
                total = sum(pts for _, pts, _ in events)
                info = PARTICIPANT_INFO.get(participant, {'grupo': 'Pipoca'})
                week_points_list.append({
                    'name': participant,
                    'total': total,
                    'events': events,
                    'grupo': info.get('grupo', 'Pipoca'),
                    'avatar': AVATARS.get(participant, '')
                })

        week_points_list = sorted(week_points_list, key=lambda x: -x['total'])

        if week_points_list:
            print('\n**PontuaÃ§Ãµes da semana:**\n')
            print('<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 0.8rem; margin: 1rem 0;">')

            for wp in week_points_list:
                participant_color = participant_colors.get(wp['name'], '#666')
                pts_color = '#27ae60' if wp['total'] > 0 else '#e74c3c'
                avatar = wp['avatar']

                events_str = ' '.join([f"{POINTS_EMOJI.get(e, 'â€¢')}" for e, _, _ in wp['events']])

                print(f'''
<div style="background: #2a2a2a; border-radius: 8px; padding: 0.8rem; display: flex; align-items: center; gap: 0.8rem; border-left: 3px solid {participant_color};">
''')
                if avatar:
                    print(f'<img src="{avatar}" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid {participant_color}; object-fit: cover;">')
                print(f'''
<div style="flex: 1;">
<div style="font-weight: bold; color: #fff;">{wp['name']}</div>
<div style="font-size: 0.8rem; color: #888;">{events_str}</div>
</div>
<div style="font-size: 1.3rem; font-weight: bold; color: {pts_color};">{wp['total']:+d}</div>
</div>
''')

                print('</div>')
        else:
            print('\n*Nenhum ponto registrado nesta semana.*\n')

        print()

    print(':::')
else:
    print('*Nenhuma semana registrada ainda.*\n')
```

# Sistema de Pontos {#pontos}

<div style="background: #2a2a2a; border-radius: 12px; padding: 1.2rem; margin: 1rem 0; border-left: 4px solid #17a2b8;">

**Como funciona o Cartola BBB**

O Cartola BBB Ã© um sistema de fantasy onde cada evento do jogo pontua. Os pontos sÃ£o **calculados automaticamente** da API para eventos detectÃ¡veis (LÃ­der, Anjo, Monstro, ParedÃ£o, VIP) e complementados com eventos manuais (Big Fone, saÃ­das).

**ObservaÃ§Ãµes**: seguimos as regras oficiais, mas **nÃ£o modelamos** a janela de escalaÃ§Ã£o nem palpites â€” calculamos pelos eventos reais do jogo.
**Regras-chave**: LÃ­der nÃ£o acumula com outros itens; Anjo autoimune acumula com Imunizado; Imunizado nÃ£o acumula com NÃ£o Emparedado/NÃ£o recebeu votos/Salvo.

</div>

```{python}
#| label: points-reference
#| output: asis

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Points reference table (matching dashboard style)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print('''
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin: 1.5rem 0;">

<div style="background: linear-gradient(180deg, rgba(39, 174, 96, 0.15) 0%, rgba(39, 174, 96, 0.05) 100%); border: 1px solid rgba(39, 174, 96, 0.3); border-radius: 12px; padding: 1.2rem;">
<h4 style="color: #27ae60; margin-top: 0; border-bottom: 1px solid rgba(39, 174, 96, 0.3); padding-bottom: 0.5rem;">ğŸ“ˆ Eventos Positivos</h4>
<table style="width: 100%; font-size: 0.9rem;">
''')

for event, points in CARTOLA_POINTS.items():
    if points > 0:
        emoji = POINTS_EMOJI.get(event, 'â€¢')
        label = POINTS_LABELS.get(event, event)
        # Mark auto-detected events
        auto = ' <span style="color: #888; font-size: 0.7rem;">(API)</span>' if event in ['lider', 'anjo', 'imunizado', 'vip'] else ''
        print(f'<tr><td style="color: #ccc; padding: 0.3rem 0;">{emoji} {label}{auto}</td><td style="color: #27ae60; text-align: right; font-weight: bold; padding: 0.3rem 0;">+{points}</td></tr>')

print('''
</table>
</div>

<div style="background: linear-gradient(180deg, rgba(231, 76, 60, 0.15) 0%, rgba(231, 76, 60, 0.05) 100%); border: 1px solid rgba(231, 76, 60, 0.3); border-radius: 12px; padding: 1.2rem;">
<h4 style="color: #e74c3c; margin-top: 0; border-bottom: 1px solid rgba(231, 76, 60, 0.3); padding-bottom: 0.5rem;">ğŸ“‰ Eventos Negativos</h4>
<table style="width: 100%; font-size: 0.9rem;">
''')

for event, points in CARTOLA_POINTS.items():
    if points < 0:
        emoji = POINTS_EMOJI.get(event, 'â€¢')
        label = POINTS_LABELS.get(event, event)
        # Mark auto-detected events
        auto = ' <span style="color: #888; font-size: 0.7rem;">(API)</span>' if event in ['monstro', 'emparedado'] else ''
        print(f'<tr><td style="color: #ccc; padding: 0.3rem 0;">{emoji} {label}{auto}</td><td style="color: #e74c3c; text-align: right; font-weight: bold; padding: 0.3rem 0;">{points}</td></tr>')

print('''
</table>
</div>

</div>
''')

print('<p class="text-muted small">Eventos marcados com <span style="color: #888;">(API)</span> sÃ£o detectados automaticamente dos snapshots diÃ¡rios.</p>')
print('<p class="text-muted small">Regras: <strong>Salvo do ParedÃ£o</strong> = venceu o Bate e Volta; <strong>NÃ£o Eliminado</strong> = indicado que permaneceu; <strong>NÃ£o Emparedado</strong> = disponÃ­vel para votaÃ§Ã£o e fora da lista final (exclui lÃ­der/anjo/imunizados e quem venceu o Bate e Volta).</p>')
```

::: {.callout-note title="Fontes de Dados"}
- **AutomÃ¡tico (API)**: LÃ­der, Anjo, Monstro, ParedÃ£o, Imune, VIP â€” detectados dos snapshots diÃ¡rios
- **Manual**: Big Fone, Quarto Secreto, saÃ­das (desistÃªncia/eliminaÃ§Ã£o) â€” registrados em `data/manual_events.json`
:::
