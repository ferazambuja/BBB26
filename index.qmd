---
title: "BBB 26 â€” Painel de ReaÃ§Ãµes"
subtitle: "AnÃ¡lise das reaÃ§Ãµes entre os participantes do Big Brother Brasil 2026"
lang: pt-BR
format:
  html:
    code-tools: false
execute:
  echo: false
  warning: false
---

```{python}
#| label: setup
#| include: false

import json
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.colors as mcolors
import seaborn as sns
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
from pathlib import Path
from collections import defaultdict, Counter
from datetime import datetime

import sys
sys.path.append(str(Path("scripts").resolve()))
from data_utils import (
    require_clean_manual_events, setup_bbb_dark_theme,
    REACTION_EMOJI, REACTION_SLUG_TO_LABEL, SENTIMENT_WEIGHTS,
    POSITIVE, MILD_NEGATIVE, STRONG_NEGATIVE, GROUP_COLORS,
    POWER_EVENT_EMOJI, POWER_EVENT_LABELS,
)

require_clean_manual_events()
setup_bbb_dark_theme()

# ConfiguraÃ§Ãµes visuais
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 11
sns.set_theme(style="whitegrid", palette="husl")

# DiretÃ³rios
DERIVED_DIR = Path("data/derived")
INDEX_DATA_FILE = DERIVED_DIR / "index_data.json"

MEMBER_OF = {}  # preenchido ao carregar dados
```

```{python}
#| label: load-data

index_data = {}
if INDEX_DATA_FILE.exists():
    with open(INDEX_DATA_FILE, encoding="utf-8") as f:
        index_data = json.load(f)

if not index_data:
    raise RuntimeError("index_data.json nÃ£o encontrado. Execute scripts/build_derived_data.py")

latest = index_data.get("latest", {})
current_week = index_data.get("current_week")
current_cycle_week = index_data.get("current_cycle_week")
active_names = index_data.get("active_names", [])
MEMBER_OF = index_data.get("member_of", {})
AVATARS = index_data.get("avatars", {})
```

```{python}
#| label: viz-functions
#| include: false

def make_sentiment_ranking(rows, title_suffix="", fixed_height=None):
    """Retorna go.Figure com ranking horizontal de sentimento."""
    if not rows:
        return go.Figure()

    df_sent = pd.DataFrame(rows).sort_values('score', ascending=True)

    color_map = {name: GROUP_COLORS.get(m, '#999')
                 for name, m in zip(df_sent['name'], df_sent['group'])}

    fig = go.Figure()
    fig.add_trace(go.Bar(
        y=df_sent['name'],
        x=df_sent['score'],
        orientation='h',
        marker_color=[color_map[n] for n in df_sent['name']],
        text=[f"{s:+.1f}" for s in df_sent['score']],
        textposition='outside',
        hovertemplate='%{y}: %{x:+.1f}<br>â¤ï¸: %{customdata[0]} | Neg: %{customdata[1]}<extra></extra>',
        customdata=list(zip(df_sent['hearts'], df_sent['negative'])),
        showlegend=False
    ))

    title = "Ranking de Sentimento"
    if title_suffix:
        title += f" â€” {title_suffix}"

    left_margin = 150
    chart_height = fixed_height if fixed_height else max(500, len(df_sent) * 32)

    fig.update_layout(
        title=title,
        xaxis_title="Score de Sentimento",
        yaxis_title="",
        height=chart_height,
        margin=dict(l=left_margin),
        shapes=[dict(type='line', x0=0, x1=0, y0=-0.5, y1=len(df_sent)-0.5,
                     line=dict(color='red', dash='dash', width=1))]
    )

    for group, color in GROUP_COLORS.items():
        fig.add_trace(go.Scatter(
            x=[None], y=[None], mode='markers',
            marker=dict(size=10, color=color),
            name=group, showlegend=True
        ))

    return fig


def make_cross_table_heatmap(participants, matrix, title_suffix=""):
    """Retorna go.Figure com heatmap da tabela cruzada de reaÃ§Ãµes."""
    active_names_ht = sorted([p['name'] for p in participants
                              if not p.get('characteristics', {}).get('eliminated')])

    heat_data = np.zeros((len(active_names_ht), len(active_names_ht)))
    rxn_labels = []
    for i, giver in enumerate(active_names_ht):
        row_labels = []
        for j, receiver in enumerate(active_names_ht):
            if giver == receiver:
                heat_data[i, j] = np.nan
                row_labels.append('â€”')
            else:
                rxn = matrix.get((giver, receiver), '')
                weight = SENTIMENT_WEIGHTS.get(rxn, 0)
                heat_data[i, j] = weight
                emoji = REACTION_EMOJI.get(rxn, '?')
                row_labels.append(emoji)
        rxn_labels.append(row_labels)

    short_names = [n.split()[0] if len(n) > 12 else n for n in active_names_ht]

    fig = go.Figure(data=go.Heatmap(
        z=heat_data,
        x=short_names,
        y=short_names,
        colorscale=[
            [0, '#d73027'],
            [0.25, '#fc8d59'],
            [0.5, '#ffffbf'],
            [1.0, '#1a9850'],
        ],
        zmin=-1, zmax=1,
        text=[[rxn_labels[i][j] for j in range(len(active_names_ht))] for i in range(len(active_names_ht))],
        texttemplate='%{text}',
        textfont=dict(size=14),
        hovertemplate='%{y} â†’ %{x}: %{text}<extra></extra>',
        colorbar=dict(title="Sentimento", tickvals=[-1, -0.5, 0, 1],
                      ticktext=['Forte Neg', 'Leve Neg', 'Neutro', 'Positivo'])
    ))

    title = "Mapa de ReaÃ§Ãµes"
    if title_suffix:
        title += f" â€” {title_suffix}"

    fig.update_layout(
        title=title,
        xaxis_title="Receptor â†",
        yaxis_title="Emissor â†’",
        height=750,
        xaxis=dict(tickangle=45, side='bottom'),
        yaxis=dict(autorange='reversed')
    )

    return fig


def make_cross_table_html(cross_data, title_suffix=""):
    """Retorna HTML string com tabela cruzada de reaÃ§Ãµes (sticky header/column)."""
    active_names = cross_data.get("names", [])
    matrix = cross_data.get("matrix", [])
    short_names = [n.split()[0] if len(n) > 10 else n for n in active_names]

    # Color mapping based on sentiment
    def get_cell_style(rxn):
        if not rxn:
            return "background: #444; color: #888;"
        weight = SENTIMENT_WEIGHTS.get(rxn, 0)
        if weight == 1:  # Positive
            return "background: #1a9850; color: #fff;"
        elif weight == -0.5:  # Mild negative
            return "background: #fc8d59; color: #000;"
        elif weight == -1:  # Strong negative
            return "background: #d73027; color: #fff;"
        return "background: #ffffbf; color: #000;"

    # Build HTML table
    html = []
    html.append(f'''
<div style="overflow-x: auto; max-width: 100%;">
<style>
.cross-table {{
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.85rem;
    width: max-content;
}}
.cross-table th, .cross-table td {{
    padding: 4px 6px;
    text-align: center;
    border: 1px solid #555;
    min-width: 36px;
    white-space: nowrap;
}}
.cross-table thead th {{
    position: sticky;
    top: 0;
    background: #222;
    z-index: 2;
    font-weight: bold;
}}
.cross-table tbody th {{
    position: sticky;
    left: 0;
    background: #222;
    z-index: 1;
    font-weight: bold;
    text-align: right;
}}
.cross-table thead th:first-child {{
    z-index: 3;
    left: 0;
}}
.cross-table td {{ font-size: 1.1rem; }}
.cross-table td:hover {{ outline: 2px solid #fff; }}
</style>
<table class="cross-table">
<thead>
<tr>
<th style="background: #222;">â†“ deu / recebeu â†’</th>
''')

    # Header row with receiver names
    for short in short_names:
        html.append(f'<th>{short}</th>')
    html.append('</tr></thead><tbody>')

    # Data rows
    for i, giver in enumerate(active_names):
        html.append(f'<tr><th>{short_names[i]}</th>')
        for j, receiver in enumerate(active_names):
            if giver == receiver:
                html.append('<td style="background: #333; color: #666;">â€”</td>')
            else:
                rxn = matrix[i][j] if i < len(matrix) and j < len(matrix[i]) else ""
                emoji = REACTION_EMOJI.get(rxn, '?') if rxn else '?'
                style = get_cell_style(rxn)
                tooltip = f"{giver} â†’ {receiver}: {rxn or 'N/A'}"
                html.append(f'<td style=\"{style}\" title=\"{tooltip}\">{emoji}</td>')
        html.append('</tr>')

    html.append('</tbody></table></div>')

    return '\n'.join(html)


def make_reaction_summary_html(summary_data, collapsed_rows=5):
    """Retorna HTML com tabela de reaÃ§Ãµes recebidas, colapsÃ¡vel com cores."""
    summary_rows = summary_data.get("rows", [])
    max_hearts = summary_data.get("max_hearts", 1) or 1
    max_neg = summary_data.get("max_neg", 1) or 1
    n_total = len(summary_rows)

    def heart_color(val):
        if val == 0: return "color: #666;"
        intensity = min(val / max_hearts, 1)
        if intensity > 0.7: return "background: #1a9850; color: #fff; font-weight: bold;"
        if intensity > 0.4: return "background: #91cf60; color: #000;"
        return "color: #a6d96a;"

    def neg_color(val):
        if val == 0: return "color: #666;"
        if val >= 3: return "background: #d73027; color: #fff; font-weight: bold;"
        if val >= 2: return "background: #fc8d59; color: #000;"
        return "color: #fdae61;"

    def score_color(val):
        if val >= 10: return "background: #1a9850; color: #fff; font-weight: bold;"
        if val >= 5: return "color: #66bd63;"
        if val >= 0: return "color: #a6d96a;"
        if val >= -5: return "color: #fdae61;"
        if val >= -10: return "color: #f46d43;"
        return "background: #d73027; color: #fff; font-weight: bold;"

    html = []
    html.append(f'''
<style>
.summary-table {{
    border-collapse: collapse;
    font-size: 0.85rem;
    width: 100%;
}}
.summary-table th, .summary-table td {{
    padding: 6px 8px;
    text-align: center;
    border-bottom: 1px solid #444;
}}
.summary-table th {{
    background: #222;
    position: sticky;
    top: 0;
    z-index: 1;
}}
.summary-table th:first-child, .summary-table td:first-child {{
    text-align: left;
    position: sticky;
    left: 0;
    background: #222;
    z-index: 2;
}}
.summary-table thead th:first-child {{ z-index: 3; }}
.summary-table tbody tr:hover {{ background: #333; }}
.collapsed-rows {{ display: none; }}
.expand-btn {{
    display: block;
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    background: #2a2a2a;
    border: 1px solid #444;
    border-radius: 6px;
    color: #ccc;
    cursor: pointer;
    font-size: 0.9rem;
}}
.expand-btn:hover {{ background: #333; }}
</style>
<div style="overflow-x: auto; max-width: 100%;">
<table class="summary-table" id="reaction-summary-table">
<thead>
<tr>
<th>Participante</th>
<th>â¤ï¸</th>
<th>ğŸŒ±</th>
<th>ğŸ’¼</th>
<th>ğŸª</th>
<th>ğŸ</th>
<th>ğŸ¯</th>
<th>ğŸ¤®</th>
<th>ğŸ¤¥</th>
<th>ğŸ’”</th>
<th>Score</th>
</tr>
</thead>
<tbody>
''')

    for i, r in enumerate(summary_rows):
        row_class = 'collapsed-rows' if i >= collapsed_rows else ''
        html.append(f'<tr class="{row_class}">')
        html.append(f'<td>{r["name"]}</td>')
        html.append(f'<td style="{heart_color(r["hearts"])}">{r["hearts"]}</td>')
        html.append(f'<td style="{neg_color(r["planta"])}">{r["planta"] or "Â·"}</td>')
        html.append(f'<td style="{neg_color(r["mala"])}">{r["mala"] or "Â·"}</td>')
        html.append(f'<td style="{neg_color(r["biscoito"])}">{r["biscoito"] or "Â·"}</td>')
        html.append(f'<td style="{neg_color(r["cobra"])}">{r["cobra"] or "Â·"}</td>')
        html.append(f'<td style="{neg_color(r["alvo"])}">{r["alvo"] or "Â·"}</td>')
        html.append(f'<td style="{neg_color(r["vomito"])}">{r["vomito"] or "Â·"}</td>')
        html.append(f'<td style="{neg_color(r["mentiroso"])}">{r["mentiroso"] or "Â·"}</td>')
        html.append(f'<td style="{neg_color(r["coracao_partido"])}">{r["coracao_partido"] or "Â·"}</td>')
        html.append(f'<td style="{score_color(r["score"])}">{r["score"]:+.1f}</td>')
        html.append('</tr>')

    html.append('</tbody></table></div>')

    if n_total > collapsed_rows:
        html.append(f'''
<button class="expand-btn" onclick="
    var rows = document.querySelectorAll('.collapsed-rows');
    var btn = this;
    if (btn.dataset.expanded === 'true') {{
        rows.forEach(r => r.style.display = 'none');
        btn.innerHTML = 'â–¼ Ver todos os {n_total} participantes';
        btn.dataset.expanded = 'false';
    }} else {{
        rows.forEach(r => r.style.display = 'table-row');
        btn.innerHTML = 'â–² Mostrar menos';
        btn.dataset.expanded = 'true';
    }}
" data-expanded="false">â–¼ Ver todos os {n_total} participantes</button>
''')

    return '\n'.join(html)


def make_negative_givers_chart(participants, matrix, title_suffix=""):
    """Retorna go.Figure com perfil de emissÃ£o de reaÃ§Ãµes (â¤ï¸ vs negativos)."""
    active_ns = sorted([p['name'] for p in participants
                        if not p.get('characteristics', {}).get('eliminated')])

    giver_data = []
    for name in active_ns:
        pos_given = 0
        neg_given = 0
        for receiver in active_ns:
            if name == receiver:
                continue
            rxn = matrix.get((name, receiver), '')
            if rxn in POSITIVE:
                pos_given += 1
            elif rxn:
                neg_given += 1

        total = pos_given + neg_given
        neg_pct = (neg_given / total * 100) if total > 0 else 0

        giver_data.append({
            'Participante': name,
            'â¤ï¸ dados': pos_given,
            'Negativos dados': neg_given,
            '% Negativo': round(neg_pct, 1),
            'Grupo': MEMBER_OF.get(name, '?')
        })

    df_givers = pd.DataFrame(giver_data).sort_values('% Negativo', ascending=True)

    fig = go.Figure()
    fig.add_trace(go.Bar(
        y=df_givers['Participante'],
        x=df_givers['â¤ï¸ dados'],
        name='â¤ï¸ dados',
        orientation='h',
        marker_color='#1a9850'
    ))
    fig.add_trace(go.Bar(
        y=df_givers['Participante'],
        x=df_givers['Negativos dados'],
        name='Negativos dados',
        orientation='h',
        marker_color='#d73027'
    ))

    title = "Perfil de EmissÃ£o: Quem DÃ¡ Mais â¤ï¸ vs Negatividade?"
    if title_suffix:
        title += f" â€” {title_suffix}"

    fig.update_layout(
        title=title,
        xaxis_title="Quantidade de reaÃ§Ãµes dadas",
        yaxis_title="",
        barmode='stack',
                height=max(500, len(df_givers) * 25),
        margin=dict(l=150)
    )

    return fig
```

```{python}
#| label: compute-highlights
#| output: asis

highlights = index_data.get("highlights", {}).get("items", [])
date_display_pt = index_data.get("highlights", {}).get("date_display", "")

if highlights:
    print(f'''
::: {{.callout-tip title="Destaques do Dia ({date_display_pt})" appearance="simple"}}
''')
    for h in highlights:
        print(f"- {h}")
    print('''
:::
''')
else:
    print(f'''
::: {{.callout-note title="Destaques do Dia ({date_display_pt})" appearance="simple"}}
Primeiro dia de dados â€” sem comparaÃ§Ãµes disponÃ­veis ainda.
:::
''')

contrad = index_data.get("contradictions", [])
if contrad:
    top_list = [f"{c.get('ator')} â†’ {c.get('alvo')} ({'nÃ£o ganha' if c.get('tipo') == 'nao_ganha' else (c.get('tema') or 'bomba')})"
                for c in contrad][:5]
    print(f'''
::: {{.callout-note title="ContradiÃ§Ãµes do SincerÃ£o (negativo + â¤ï¸)" appearance="simple"}}
''')
    for item in top_list:
        print(f"- {item}")
    print('''
:::
''')
```

# VisÃ£o Geral {#visao-geral-main}

```{python}
#| label: overview-stats
#| output: asis

overview = index_data.get("overview", {})
n_active = overview.get("n_active", 0)
total_hearts = overview.get("total_hearts", 0)
total_negative = overview.get("total_negative", 0)
n_two_sided = overview.get("n_two_sided", 0)
n_one_sided = overview.get("n_one_sided", 0)
n_blind_spots = overview.get("n_blind_spots", 0)
date_display = overview.get("date_display", "")
n_daily = overview.get("n_daily", 0)

print(f'''
<div style="display: flex; flex-wrap: wrap; gap: 0.8rem; margin: 1.5rem 0;">

<div style="flex: 1 1 150px; min-width: 120px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 10px; padding: 1rem; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.3);">
<div style="font-size: 2rem; font-weight: bold; color: #fff;">{n_active}</div>
<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); text-transform: uppercase;">Participantes</div>
</div>

<div style="flex: 1 1 150px; min-width: 120px; background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border-radius: 10px; padding: 1rem; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.3);">
<div style="font-size: 2rem; font-weight: bold; color: #fff;">{total_hearts}</div>
<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); text-transform: uppercase;">â¤ï¸ CoraÃ§Ãµes</div>
</div>

<div style="flex: 1 1 150px; min-width: 120px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border-radius: 10px; padding: 1rem; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.3);">
<div style="font-size: 2rem; font-weight: bold; color: #fff;">{total_negative}</div>
<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); text-transform: uppercase;">Negativos</div>
</div>

<a href="trajetoria.html#hostilidades-dia" style="flex: 1 1 150px; min-width: 120px; text-decoration: none;">
<div style="background: linear-gradient(135deg, #d73027 0%, #a50026 100%); border-radius: 10px; padding: 1rem; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.3); cursor: pointer; height: 100%; box-sizing: border-box;">
<div style="font-size: 2rem; font-weight: bold; color: #fff;">{n_two_sided}</div>
<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); text-transform: uppercase;">âš”ï¸ Inimigos</div>
<div style="font-size: 0.65rem; color: rgba(255,255,255,0.6); margin-top: 0.2rem;">pares mÃºtuos</div>
</div>
</a>

<a href="trajetoria.html#hostilidades-dia" style="flex: 1 1 150px; min-width: 120px; text-decoration: none;">
<div style="background: linear-gradient(135deg, #f39c12 0%, #d68910 100%); border-radius: 10px; padding: 1rem; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.3); cursor: pointer; height: 100%; box-sizing: border-box;">
<div style="font-size: 2rem; font-weight: bold; color: #fff;">{n_one_sided}</div>
<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); text-transform: uppercase;">ğŸ­ Falsos Amigos</div>
<div style="font-size: 0.65rem; color: rgba(255,255,255,0.6); margin-top: 0.2rem;">A detesta B, B dÃ¡ â¤ï¸</div>
</div>
</a>

<a href="trajetoria.html#hostilidades-dia" style="flex: 1 1 150px; min-width: 120px; text-decoration: none;">
<div style="background: linear-gradient(135deg, #8e44ad 0%, #6c3483 100%); border-radius: 10px; padding: 1rem; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.3); cursor: pointer; height: 100%; box-sizing: border-box;">
<div style="font-size: 2rem; font-weight: bold; color: #fff;">{n_blind_spots}</div>
<div style="font-size: 0.75rem; color: rgba(255,255,255,0.85); text-transform: uppercase;">ğŸ‘ï¸ Pontos Cegos</div>
<div style="font-size: 0.65rem; color: rgba(255,255,255,0.6); margin-top: 0.2rem;">dÃ£o â¤ï¸ a inimigos</div>
</div>
</a>

</div>

<p class="text-muted small" style="margin-top: 0.3rem; text-align: center;">ğŸ“… Dados de <strong>{date_display}</strong> â€” {n_daily} dias de histÃ³rico</p>
''')
```

```{python}
#| label: paredao-status-card
#| output: asis

paredao_names = index_data.get("paredao", {}).get("names", [])
if paredao_names:
    status_text = "Em VotaÃ§Ã£o"
    status_color = "#e74c3c"
    status_icon = "ğŸ—³ï¸"
    names_display = ", ".join(sorted(paredao_names))
    emparedados_html = f'<div style="color: #ccc; font-size: 0.95rem;">Emparedados: <strong>{names_display}</strong></div>'
else:
    status_text = "Aguardando formaÃ§Ã£o"
    status_color = "#6c757d"
    status_icon = "â³"
    emparedados_html = '<div style="color: #888; font-size: 0.9rem;">Nenhum paredÃ£o ativo no momento</div>'

print(f'''
<div style="background: #2a2a2a; border-radius: 12px; padding: 1rem 1.2rem; margin: 1rem 0 1.5rem 0; border-left: 4px solid {status_color}; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
<div>
<div style="font-size: 1.1rem; font-weight: bold; color: #fff; margin-bottom: 0.3rem;">
{status_icon} ParedÃ£o: <span style="color: {status_color};">{status_text}</span>
</div>
{emparedados_html}
</div>
<a href="paredao.html" style="background: {status_color}; color: #fff; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-weight: 500; font-size: 0.9rem; white-space: nowrap;">
Ver anÃ¡lise â†’
</a>
</div>
''')
```

::: {.callout-warning title="ğŸ—³ï¸ ParedÃ£o"}
Para acompanhar o **paredÃ£o atual** (formaÃ§Ã£o, votaÃ§Ã£o da casa, anÃ¡lise de coerÃªncia entre reaÃ§Ãµes e votos), acesse a pÃ¡gina dedicada: **[ParedÃ£o](paredao.html)**

Para ver o **histÃ³rico de paredÃµes anteriores**, acesse: **[Arquivo de ParedÃµes](paredoes.html)**
:::

```{python}
#| label: watchlist-risco
#| output: asis

top_vulnerable = index_data.get("watchlist", [])

if top_vulnerable:
    print('''
# Watchlist de Risco {#watchlist}

Participantes com **pontos cegos** â€” dÃ£o â¤ï¸ para quem os detesta. Podem ser surpreendidos em votaÃ§Ãµes.

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin: 1.5rem 0;">
''')

    for i, p in enumerate(top_vulnerable):
        # Color by risk level
        border_color = p.get('risk_color', '#f1c40f')
        risk_label = p.get('risk_label', 'AtenÃ§Ã£o')

        grupo_color = GROUP_COLORS.get(p['grupo'], '#666')
        avatar_url = AVATARS.get(p['name'], '')

        # Show up to 3 attackers
        attackers_display = ', '.join(p['attackers'][:3])
        if len(p['attackers']) > 3:
            attackers_display += f' +{len(p["attackers"]) - 3}'

        print(f'''
<div style="background: #2a2a2a; border-radius: 10px; border-left: 4px solid {border_color}; padding: 1rem; display: flex; gap: 0.8rem; align-items: flex-start;">
<div style="flex-shrink: 0;">
<img src="{avatar_url}" alt="{p['name']}" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid {grupo_color}; object-fit: cover;">
</div>
<div style="flex: 1; min-width: 0;">
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.3rem;">
<span style="font-weight: bold; color: #fff; font-size: 1rem;">{p['name']}</span>
<span style="background: {border_color}; color: #fff; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; text-transform: uppercase;">{risk_label}</span>
</div>
<div style="color: #aaa; font-size: 0.8rem; margin-top: 0.4rem;">
DÃ¡ â¤ï¸ para <strong style="color: #e74c3c;">{p['hearts_to_enemies']}</strong> {('pessoa que o detesta' if p['hearts_to_enemies'] == 1 else 'pessoas que o detestam')}
</div>
<div style="color: #888; font-size: 0.75rem; margin-top: 0.3rem;">
ğŸ‘ï¸ Pontos cegos: <span style="color: #ccc;">{attackers_display}</span>
</div>
</div>
</div>
''')

    print('</div>')
    print(f'\n<p style="text-align: center; margin-top: 0.5rem;"><a href="trajetoria.html#hostilidades-dia" style="color: #6ea8fe; font-size: 0.85rem;">Ver anÃ¡lise completa â†’</a></p>')
else:
    print("*Nenhum participante com pontos cegos detectado.*")
```

# Ranking de Sentimento {#ranking-sentimento}

Cada participante recebe reaÃ§Ãµes dos demais. O **score de sentimento** pondera: â¤ï¸ = +1, reaÃ§Ãµes leves (ğŸŒ±ğŸ’¼ğŸª) = -0.5, reaÃ§Ãµes fortes (ğŸğŸ¯ğŸ¤®ğŸ¤¥ğŸ’”) = -1.

```{python}
#| label: ranking-prep
#| include: false

ranking_data = index_data.get("ranking", {})
_ranking_height = ranking_data.get("height", 500)
today_rows = ranking_data.get("today", [])
change_yesterday = ranking_data.get("change_yesterday", [])
change_week = ranking_data.get("change_week", [])
yesterday_label = ranking_data.get("yesterday_label")
week_ago_label = ranking_data.get("week_label")


def make_sentiment_change_table(rows, period_label):
    """Create HTML table showing sentiment changes with colors."""
    if not rows:
        return f"<p class='text-muted'>Dados insuficientes para comparaÃ§Ã£o de {period_label}.</p>"

    # Build HTML table
    html = '''
<div style="max-height: 500px; overflow-y: auto; border-radius: 8px; border: 1px solid #444;">
<table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
<thead style="position: sticky; top: 0; background: #2a2a2a; z-index: 1;">
<tr style="border-bottom: 2px solid #555;">
<th style="padding: 0.6rem; text-align: left; color: #ccc;">Participante</th>
<th style="padding: 0.6rem; text-align: center; color: #ccc;">Antes</th>
<th style="padding: 0.6rem; text-align: center; color: #ccc;">Hoje</th>
<th style="padding: 0.6rem; text-align: center; color: #ccc;">Î”</th>
</tr>
</thead>
<tbody>
'''

    for row in rows:
        # Color for delta
        if row['delta'] > 1:
            delta_color = '#27ae60'  # Green
            delta_bg = 'rgba(39, 174, 96, 0.2)'
        elif row['delta'] > 0:
            delta_color = '#58d68d'  # Light green
            delta_bg = 'rgba(88, 214, 141, 0.1)'
        elif row['delta'] < -1:
            delta_color = '#e74c3c'  # Red
            delta_bg = 'rgba(231, 76, 60, 0.2)'
        elif row['delta'] < 0:
            delta_color = '#ec7063'  # Light red
            delta_bg = 'rgba(236, 112, 99, 0.1)'
        else:
            delta_color = '#888'
            delta_bg = 'transparent'

        # Arrow emoji
        if row['delta'] > 0:
            arrow = 'ğŸ“ˆ'
        elif row['delta'] < 0:
            arrow = 'ğŸ“‰'
        else:
            arrow = 'â–'

        # Group color dot
        group_color = GROUP_COLORS.get(row['group'], '#666')

        html += f'''
<tr style="border-bottom: 1px solid #333; background: {delta_bg};">
<td style="padding: 0.5rem;"><span style="color: {group_color}; margin-right: 0.3rem;">â—</span>{row['name']}</td>
<td style="padding: 0.5rem; text-align: center; color: #aaa;">{row['past']:+.1f}</td>
<td style="padding: 0.5rem; text-align: center; font-weight: 500;">{row['today']:+.1f}</td>
<td style="padding: 0.5rem; text-align: center; color: {delta_color}; font-weight: bold;">{arrow} {row['delta']:+.1f}</td>
</tr>
'''

    html += '</tbody></table></div>'
    return html
```

::: {.panel-tabset}

## Hoje

```{python}
#| label: sentiment-ranking-today

fig = make_sentiment_ranking(today_rows, title_suffix=latest.get("label", ""), fixed_height=_ranking_height)
fig.show()
```

## Ontemâ†’Hoje

```{python}
#| label: sentiment-yesterday-today
#| output: asis

if change_yesterday:
    print(f"<p class='text-muted small'>MudanÃ§as de <strong>{yesterday_label}</strong> para <strong>{latest.get('label','')}</strong></p>")
    print(make_sentiment_change_table(change_yesterday, "ontem"))
else:
    print("<p class='text-muted'>Dados insuficientes (apenas 1 dia disponÃ­vel).</p>")
```

## Em 7 dias

```{python}
#| label: sentiment-7d-change
#| output: asis

if change_week:
    print(f"<p class='text-muted small'>MudanÃ§as de <strong>{week_ago_label}</strong> para <strong>{latest.get('label','')}</strong></p>")
    print(make_sentiment_change_table(change_week, "7 dias"))
else:
    print(f"<p class='text-muted'>Dados insuficientes (apenas {overview.get('n_daily', 0)} dias disponÃ­veis).</p>")
```

## EvoluÃ§Ã£o

```{python}
#| label: sentiment-evolution
#| output: asis

timeline_data = index_data.get("timeline", [])
df_timeline = pd.DataFrame([{
    "Data": pd.to_datetime(row["date"]),
    "Participante": row["name"],
    "Sentimento": row["sentiment"],
    "Grupo": row["group"],
} for row in timeline_data])

if not df_timeline.empty and len(df_timeline['Data'].unique()) > 1:
    # Color palette for participants
    all_parts = sorted(df_timeline['Participante'].unique())
    palette = (
        px.colors.qualitative.Plotly + px.colors.qualitative.D3 +
        px.colors.qualitative.Set2 + px.colors.qualitative.Bold
    )
    part_colors = {name: palette[i % len(palette)] for i, name in enumerate(all_parts)}

    # Top 3 and bottom 3 by latest score - visible by default
    latest_scores_df = df_timeline.groupby('Participante')['Sentimento'].last()
    top3 = set(latest_scores_df.nlargest(3).index)
    bottom3 = set(latest_scores_df.nsmallest(3).index)
    highlight = top3 | bottom3

    fig = go.Figure()

    for name in all_parts:
        df_p = df_timeline[df_timeline['Participante'] == name].sort_values('Data')
        is_hl = name in highlight

        fig.add_trace(go.Scatter(
            x=df_p['Data'], y=df_p['Sentimento'],
            mode='lines+markers',
            name=name,
            line=dict(width=3 if is_hl else 1.5, color=part_colors[name]),
            marker=dict(size=6 if is_hl else 4),
            hovertemplate=f'{name}: ' + '%{y:+.1f}<extra></extra>',
            visible=True if is_hl else 'legendonly',
        ))

    # Zero line
    fig.add_shape(type='line', x0=df_timeline['Data'].min(), x1=df_timeline['Data'].max(),
                  y0=0, y1=0, line=dict(color='red', dash='dash', width=1))

    # ParedÃ£o date lines (load from paredoes.json)
    paredoes_file = Path("data/paredoes.json")
    if paredoes_file.exists():
        with open(paredoes_file, encoding="utf-8") as f:
            paredoes_data = json.load(f)
        for p in paredoes_data.get('paredoes', []):
            paredao_date = pd.to_datetime(p['data'])
            y_range = [df_timeline['Sentimento'].min() - 2, df_timeline['Sentimento'].max() + 2]
            fig.add_shape(
                type='line', x0=paredao_date, x1=paredao_date,
                y0=y_range[0], y1=y_range[1],
                line=dict(color='#FF6B6B', dash='dot', width=2),
            )
            # Add annotation
            fig.add_annotation(
                x=paredao_date, y=y_range[1],
                text=f"ğŸ—³ï¸ {p['numero']}Âº ParedÃ£o",
                showarrow=False,
                font=dict(size=11, color='#FF6B6B'),
                yshift=10,
            )

    fig.update_layout(
        title="EvoluÃ§Ã£o do Sentimento ao Longo do Tempo",
        xaxis_title="Data",
        yaxis_title="Score de Sentimento",
        height=_ranking_height,  # Same height as Ranking tabs
        hovermode='x unified',
        legend=dict(font=dict(size=11), itemsizing='constant'),
        margin=dict(r=180),  # More room for legend
    )

    fig.show()

    print("<p class='text-muted small' style='margin-top: 0.5rem;'>Top 3 e bottom 3 destacados por padrÃ£o. Clique na legenda para mostrar/esconder outros participantes.</p>")
else:
    print("<p class='text-muted'>Dados insuficientes para grÃ¡fico de evoluÃ§Ã£o.</p>")
```

:::

# Tabela Cruzada de ReaÃ§Ãµes {#crosstable}

<p class="text-muted small">ğŸ“¸ <strong>Dado do dia</strong> â€” mostra apenas a coleta mais recente.</p>

Quem deu qual reaÃ§Ã£o para quem. Cada cÃ©lula mostra a reaÃ§Ã£o que a **linha** (emissor) deu para a **coluna** (receptor).

```{python}
#| label: cross-table
#| output: asis

cross_data = index_data.get("cross_table", {})
print(make_cross_table_html(cross_data, title_suffix=latest.get("label", "")))
```

```{python}
#| label: cross-table-summary
#| output: asis

print("\n### ReaÃ§Ãµes Recebidas por Participante\n")
print("<p class='text-muted small'>Ordenado por score de sentimento. CÃ©lulas coloridas indicam valores altos.</p>")
summary_data = index_data.get("reaction_summary", {})
print(make_reaction_summary_html(summary_data, collapsed_rows=5))
```

# Perfis Individuais {#perfis}

<p class="text-muted small">ğŸ“¸ <strong>Dado do dia</strong> â€” mostra apenas a coleta mais recente.</p>

Detalhamento estratÃ©gico de cada participante ativo, incluindo anÃ¡lise de hostilidades e vulnerabilidades no jogo.

<details style="margin: 1.5rem 0;">
<summary style="cursor: pointer; color: #fff; font-weight: 600; background: #2a2a2a; border-radius: 12px; padding: 0.9rem 1.2rem; border-left: 4px solid #17a2b8;">
â„¹ï¸ Como calculamos Vulnerabilidade, Risco externo e Animosidade (clique para expandir)
</summary>
<div style="background: #2a2a2a; border-radius: 12px; padding: 1.2rem; margin-top: 0.8rem; border-left: 4px solid #17a2b8;">

**ğŸ¯ Vulnerabilidade a Votos Surpresa**

O badge avalia o risco de receber **votos inesperados** â€” de pessoas que o participante considera aliadas mas que, na verdade, sÃ£o hostis ("falsos amigos"). Quem tem muitos inimigos declarados mas zero falsos amigos estÃ¡ em posiÃ§Ã£o mais segura: sabe exatamente de onde vÃªm as ameaÃ§as.

| Badge | CritÃ©rio | Significado |
|-------|----------|-------------|
| ğŸ”´ **MUITO VULNERÃVEL** | 5+ falsos amigos | PosiÃ§Ã£o crÃ­tica. Muitas pessoas que considera amigas podem votar contra sem que espere. |
| ğŸŸ  **VULNERÃVEL** | 3-4 falsos amigos | PosiÃ§Ã£o frÃ¡gil. Alguns "amigos" sÃ£o hostis e podem surpreender em votaÃ§Ã£o. |
| ğŸŸ¡ **ATENÃ‡ÃƒO** | 1-2 falsos amigos | PosiÃ§Ã£o razoÃ¡vel, mas com pontos cegos. |
| ğŸŸ¢ **PROTEGIDO** | 0 falsos amigos | Sem pontos cegos â€” sabe quem sÃ£o seus aliados e inimigos. |

**ğŸ§­ Risco externo (semana atual)**

Mede exposiÃ§Ã£o real a votos/eventos negativos **na semana atual** (nÃ£o carrega para a semana seguinte).  
FÃ³rmula:

```
risco_externo = 1.0 * votos_recebidos
              + Î£ pesos_prejuizos_publicos
              + 0.5 Ã— Î£ pesos_prejuizos_secretos
              + 0.5 * auto_infligidos
              + 2 (se estiver no Paredao)
```

Faixas: ğŸŸ¢ **MUITO BAIXO** (<1), ğŸŸ¡ **BAIXO** (>=1), ğŸŸ  **MÃ‰DIO** (>=3), ğŸ”´ **ALTO** (>=6).

**ğŸ”¥ Animosidade (tendÃªncia)**

Mede o quanto o participante **gerou impacto negativo** recente na casa:

```
animosidade = 0.25 * reacoes_negativas_recebidas
            + 0.5 * hostilidades_recebidas
            + 1.5 * soma_eventos_negativos_com_decaimento
```

O decaimento usa: `peso = 1 / (1 + semanas_passadas)`.  
Faixas: ğŸŸ¢ **MUITO BAIXA** (<1), ğŸŸ¡ **BAIXA** (>=1), ğŸŸ  **MÃ‰DIA** (>=3), ğŸ”´ **ALTA** (>=6).

**Categorias de RelaÃ§Ã£o:**

- **âœ… Aliados** â€” â¤ï¸ mÃºtuo. Votos seguros, nÃ£o votarÃ£o contra.
- **âš”ï¸ Inimigos Declarados** â€” Negatividade mÃºtua. Votos contra esperados de ambos os lados.
- **âš ï¸ Falsos Amigos** â€” VocÃª dÃ¡ â¤ï¸, mas eles dÃ£o negativa. **PERIGO:** podem votar contra vocÃª!
- **ğŸ—¡ï¸ Inimigos NÃ£o Declarados** â€” VocÃª dÃ¡ negativa, eles dÃ£o â¤ï¸. Eles nÃ£o sabem que sÃ£o seus alvos.

**Novos sinais de jogo (dinÃ¢micas pÃºblicas):**
- **Poderes recebidos** (benefÃ­cios e prejuÃ­zos) mostram acontecimentos **pÃºblicos** na casa que podem mudar alianÃ§as.
- **Votos da casa recebidos** mostram o que o **pÃºblico** viu na formaÃ§Ã£o; quando hÃ¡ **dedo-duro**, o voto aparece marcado.
- O painel agora separa **Risco social** (percepÃ§Ã£o) e **Risco externo** (votos/eventos negativos).
- **Risco externo Ã© experimental** e serÃ¡ recalibrado semanalmente apÃ³s indicaÃ§Ãµes/contragolpes/votaÃ§Ãµes.

</div>
</details>

```{python}
#| label: individual-profiles
#| output: asis

profiles = index_data.get("profiles", [])

source_icons = {
    'big fone': 'ğŸ“',
    'caixas-surpresa': 'ğŸ',
    'prova do lÃ­der': 'ğŸ‘‘',
    'prova do anjo': 'ğŸ˜‡',
    'castigo do monstro': 'ğŸ‘¹',
    'dinÃ¢mica da casa': 'ğŸ¬',
}

print("""
<style>
.plant-chip {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
}
.plant-chip:focus { outline: none; }
.plant-chip .plant-popover {
    position: absolute;
    top: 130%;
    left: 0;
    min-width: 240px;
    background: #1f1f1f;
    border: 1px solid #555;
    border-radius: 8px;
    padding: 0.6rem 0.7rem;
    color: #ddd;
    font-size: 0.75rem;
    box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    opacity: 0;
    pointer-events: none;
    transform: translateY(-4px);
    transition: all 0.15s ease;
    z-index: 30;
}
.plant-chip:hover .plant-popover,
.plant-chip:focus-within .plant-popover {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
}
.plant-popover .plant-title {
    display: flex;
    justify-content: space-between;
    font-weight: 600;
    margin-bottom: 0.35rem;
}
.plant-popover .plant-row {
    display: flex;
    justify-content: space-between;
    gap: 0.6rem;
    padding: 0.15rem 0;
    border-bottom: 1px solid #333;
}
.plant-popover .plant-row:last-child { border-bottom: none; }
.plant-popover .plant-muted { color: #999; font-size: 0.7rem; margin-top: 0.3rem; }
</style>
""")

def plant_color(score):
    if score >= 80:
        return "#2f7d46"
    if score >= 60:
        return "#6c8a3c"
    if score >= 40:
        return "#b9772a"
    return "#a94442"

def render_actor_avatars(actors, border_color="#666", color_lookup=None, size=24, skip_icons=None):
    if not actors:
        return ''
    parts = []
    for a in actors:
        color = border_color
        if color_lookup and a in color_lookup:
            color = color_lookup[a]
        if a in AVATARS and AVATARS[a]:
            parts.append(
                f'<img src="{AVATARS[a]}" style="width: {size}px; height: {size}px; border-radius: 50%; '
                f'border: 2px solid {color}; object-fit: cover; margin-right: -4px;">'
            )
        else:
            icon = None
            lower = a.lower() if isinstance(a, str) else ''
            for k, v in source_icons.items():
                if k in lower:
                    icon = v
                    break
            if "dinÃ¢mica da casa" in lower:
                continue
            if icon and skip_icons and icon in skip_icons:
                continue
            parts.append(f'<span style="font-size: 0.9rem;">{icon or "ğŸ¬"}</span>')
    return ''.join(parts)


def make_event_chips(events, border_color, color_lookup=None):
    if not events:
        return "<span style='color:#777;'>â€”</span>"
    chips = []
    for ev in events:
        emoji = ev.get("emoji", "â€¢")
        label = ev.get("label", ev.get("type"))
        count = ev.get("count", 1)
        actors = ev.get("actors", [])
        count_prefix = f"{count}x " if count > 1 else ""
        chip_colors = {color_lookup.get(a) for a in actors} if color_lookup else set()
        chip_colors.discard(None)
        chip_border = chip_colors.pop() if len(chip_colors) == 1 else border_color
        actor_html = render_actor_avatars(
            actors,
            chip_border,
            color_lookup=color_lookup,
            size=22,
            skip_icons={emoji} if emoji else None,
        )
        actor_label = " + ".join(actors) if actors else ""
        title = f"{label} â€” {actor_label}" if actor_label else label
        chips.append(
            f"<span style='display:inline-flex; align-items:center; gap:0.3rem; background:#2f2f2f; "
            f"border:1px solid {chip_border}; color:#ddd; border-radius:10px; padding:0.18rem 0.5rem; "
            f"font-size:0.72rem; margin:0.15rem; min-height: 28px; line-height: 1;' title='{title}'>"
            f"{count_prefix}{emoji} {label} {actor_html}</span>"
        )
    return ' '.join(chips)


for p in profiles:
    name = p.get('name')
    member_of = p.get('member_of', '?')
    group = p.get('group', '?')
    balance = p.get('balance', 0)
    roles = p.get('roles', [])
    score = p.get('score', 0)

    rxn_summary = " | ".join([f"{r['emoji']}Ã—{r['count']}" for r in p.get('rxn_summary', [])])
    given_summary = " | ".join([f"{r['emoji']}Ã—{r['count']}" for r in p.get('given_summary', [])])

    rel = p.get("relations", {})
    allies = rel.get("allies", [])
    enemies = rel.get("enemies", [])
    false_friends = rel.get("false_friends", [])
    blind_targets = rel.get("blind_targets", [])

    n_allies = len(allies)
    n_enemies = len(enemies)
    n_false_friends = len(false_friends)

    ally_names = set(allies)
    enemy_names = {n["name"] for n in enemies}
    false_friend_names = {n["name"] for n in false_friends}
    blind_names = {n["name"] for n in blind_targets}

    relation_colors = {}
    relation_colors.update({n: "#28a745" for n in ally_names})
    relation_colors.update({n: "#dc3545" for n in enemy_names})
    relation_colors.update({n: "#ffc107" for n in false_friend_names})
    relation_colors.update({n: "#6f42c1" for n in blind_names})

    events = p.get("events", {})
    pos_html = make_event_chips(events.get("pos_week", []), "#28a745", relation_colors)
    neg_html = make_event_chips(events.get("neg_week", []), "#dc3545", relation_colors)
    pos_hist_html = make_event_chips(events.get("pos_hist", []), "#2ecc71", relation_colors) if events.get("pos_hist") else ""
    neg_hist_html = make_event_chips(events.get("neg_hist", []), "#e74c3c", relation_colors) if events.get("neg_hist") else ""
    hist_html = ""
    if events.get("pos_hist"):
        hist_html += f"<span style='color:#28a745;'>{pos_hist_html}</span>"
    if events.get("neg_hist"):
        hist_html += f"<span style='color:#dc3545; margin-left:0.35rem;'>{neg_hist_html}</span>"

    votes = p.get("votes_received", [])
    if votes:
        vote_chips = []
        for v in votes:
            voter = v.get("voter")
            count = v.get("count", 1)
            is_revealed = v.get("revealed", False)
            count_prefix = f"{count}x " if count > 1 else ""
            border = relation_colors.get(voter, "#666")
            reveal_glow = "box-shadow: 0 0 0 2px #17a2b8 inset;" if is_revealed else ""
            badge = " ğŸ‘ï¸" if is_revealed else ""
            avatar_html = render_actor_avatars([voter], border, color_lookup=relation_colors, size=22)
            title = f"Voto revelado de {voter}" if is_revealed else f"Voto de {voter}"
            vote_chips.append(
                f"<span style='display:inline-flex; align-items:center; gap:0.3rem; background:#2f2f2f; "
                f"border:1px solid {border}; color:#ddd; border-radius:999px; padding:0.2rem 0.45rem; "
                f"font-size:0.72rem; margin:0.15rem; min-height: 28px; line-height: 1; {reveal_glow}' title='{title}'>"
                f"{count_prefix}{avatar_html}{voter}{badge}</span>"
            )
        votes_html = ' '.join(vote_chips)
    else:
        votes_html = ""

    sinc = p.get("sincerao", {})
    chips = []
    for reason in sinc.get("reasons", []):
        chips.append(
            f"<span style='display:inline-flex; align-items:center; gap:0.3rem; background:#2f2f2f; "
            f"border:1px solid #17a2b8; color:#ddd; border-radius:10px; padding:0.18rem 0.5rem; "
            f"font-size:0.72rem; margin:0.15rem;'>{reason}</span>"
        )
    for tema, count in (sinc.get("bombas", {}) or {}).items():
        prefix = f"{count}x " if count > 1 else ""
        chips.append(
            f"<span style='display:inline-flex; align-items:center; gap:0.3rem; background:#2f2f2f; "
            f"border:1px solid #17a2b8; color:#ddd; border-radius:10px; padding:0.18rem 0.5rem; "
            f"font-size:0.72rem; margin:0.15rem;'>ğŸ’£ {prefix}{tema}</span>"
        )
    sincerao_html = " ".join(chips) if chips else ""

    sinc_contra = p.get("sinc_contra", {})
    sinc_contra_count = sinc_contra.get("count", 0)
    sinc_contra_label = ""
    if sinc_contra_count:
        targets_txt = ", ".join(sinc_contra.get("targets", []))
        plural = "Ãµes" if sinc_contra_count > 1 else "Ã£o"
        sinc_contra_label = (
            f"<span title='ContradiÃ§{plural} com: {targets_txt}' "
            f"style='font-size: 0.5em; padding: 3px 10px; border-radius: 4px; "
            f"background: #6f42c1; color: #fff; vertical-align: middle; font-weight: bold;'>"
            f"ContradiÃ§Ã£o {sinc_contra_count}x</span>"
        )

    risk_level = p.get("risk_level")
    risk_color = p.get("risk_color")
    external_level = p.get("external_level")
    external_color = p.get("external_color")
    animosity_level = p.get("animosity_level")
    animosity_color = p.get("animosity_color")
    plant_info = p.get("plant_index") or {}
    plant_badge = ""
    if plant_info and plant_info.get("score") is not None:
        score_week = plant_info.get("score", 0)
        score_roll = plant_info.get("rolling", score_week)
        score_val = int(round(score_roll))
        plant_week = plant_info.get("week")
        plant_color_hex = plant_color(score_val)
        breakdown_rows = []
        for item in plant_info.get("breakdown", []):
            points = item.get("points", 0)
            if points <= 0:
                continue
            label = item.get("label", "")
            breakdown_rows.append(
                f"<div class='plant-row'><span>{label}</span><span>+{points}</span></div>"
            )
        breakdown_html = "".join(breakdown_rows) if breakdown_rows else "<div class='plant-muted'>Sem sinais fortes.</div>"
        points_map = {item.get("label"): item.get("points", 0) for item in plant_info.get("breakdown", [])}
        emoji_points = points_map.get("Emoji ğŸŒ±", 0)
        raw = plant_info.get("raw", {})
        raw_power = raw.get("power_events", 0)
        sinc_part = raw.get("sincerao_participation", None)
        sinc_label = "participou" if sinc_part else ("ausente" if sinc_part is False else "n/a")
        plant_badge = (
            f"<span class='plant-chip' tabindex='0' "
            f"style=\"font-size: 0.5em; padding: 3px 10px; border-radius: 4px; "
            f"background: {plant_color_hex}; color: #fff; vertical-align: middle; font-weight: bold;\">"
            f"Planta Index {score_val}"
            f"<div class='plant-popover'>"
            f"<div class='plant-title'><span>Planta Index</span><span>{score_val}/100</span></div>"
            f"<div class='plant-muted'>Semana {plant_week} | Rolling {score_roll:.1f}</div>"
            f"{breakdown_html}"
            f"<div class='plant-muted'>Eventos de poder: {raw_power} | SincerÃ£o: {sinc_label}</div>"
            f"<div class='plant-muted'>Emoji ğŸŒ±: +{emoji_points}</div>"
            f"</div></span>"
        )

    avatar_url = AVATARS.get(name, '')
    cor_grupo = GROUP_COLORS.get(member_of, '#666')

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # PROFILE CARD - Using HTML tables for better formatting
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    role_text = f" | {', '.join(roles)}" if roles else ""
    badges = " ".join([
        f"<span style=\"font-size: 0.5em; padding: 3px 10px; border-radius: 4px; background: {risk_color}; color: #fff; vertical-align: middle; font-weight: bold;\">{risk_level}</span>",
        f"<span style=\"font-size: 0.5em; padding: 3px 10px; border-radius: 4px; background: {external_color}; color: #fff; vertical-align: middle; font-weight: bold;\">Risco externo {external_level}</span>",
        f"<span style=\"font-size: 0.5em; padding: 3px 10px; border-radius: 4px; background: {animosity_color}; color: #fff; vertical-align: middle; font-weight: bold;\">Animosidade {animosity_level}</span>",
        sinc_contra_label or "",
        plant_badge or "",
    ]).strip()
    avatar_html = (f'<img src="{avatar_url}" alt="{name}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid {cor_grupo}; flex-shrink: 0;">'
                   if avatar_url else "")
    print(f'''
<div style="margin-top: 2rem; margin-bottom: 1rem; border: 1px solid #444; border-radius: 12px; overflow: hidden; background: #2a2a2a;">

<!-- Header with avatar -->
<div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: linear-gradient(90deg, rgba(48,48,48,0.9), rgba(48,48,48,0.3)); border-left: 5px solid {cor_grupo};">
{avatar_html}
<div>
<h3 style="margin: 0 0 0.3rem 0; color: #fff; font-size: 1.4em;">{name} {badges}</h3>
<div style="color: #aaa; font-size: 0.95em;">
<strong style="color: {cor_grupo};">{member_of}</strong> | {group} | VIP: {p.get('vip_days', 0)}d | Xepa: {p.get('xepa_days', 0)}d | Saldo: {balance:,} | Sentimento: <strong style="color: {'#28a745' if score >= 0 else '#dc3545'};">{score:+.1f}</strong>{role_text}
</div>
</div>
</div>

<!-- Reactions -->
<div style="padding: 0.8rem 1rem; border-bottom: 1px solid #444; background: #333;">
<div style="display: flex; flex-wrap: wrap; gap: 1.5rem;">
<div><strong style="color: #888;">Recebeu:</strong> {rxn_summary}</div>
<div><strong style="color: #888;">Deu:</strong> {given_summary}</div>
</div>
</div>

{f'''
<!-- Game Dynamics -->
<div style="padding: 0.8rem 1rem; border-bottom: 1px solid #444; background: #2f2f2f;">
<div style="font-weight: bold; color: #fff; margin-bottom: 0.5rem;">âš¡ DinÃ¢micas do Jogo</div>
<div style="display: grid; grid-template-columns: 1fr; gap: 0.4rem; font-size: 0.9em;">
  {f"<div style='display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap;'><strong style='color: #28a745;'>+ BenefÃ­cios (semana):</strong> {pos_html}</div>" if events.get('pos_week') else ""}
  {f"<div style='display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap;'><strong style='color: #dc3545;'>âˆ’ PrejuÃ­zos (semana):</strong> {neg_html}</div>" if events.get('neg_week') else ""}
  {f"<div style='display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap;'><strong style='color: #ffc107;'>ğŸ—³ï¸ Votos recebidos:</strong> {votes_html}</div>" if votes else ""}
  {f"<div style='display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap;'><strong style='color: #17a2b8;'>ğŸ”¥ SincerÃ£o (semana):</strong> {sincerao_html}</div>" if sincerao_html else ""}
  {f"<div style='display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap;'><strong style='color: #999;'>HistÃ³rico da temporada:</strong> {hist_html}</div>" if (events.get('pos_hist') or events.get('neg_hist')) else ""}
</div>
</div>
''' if (events.get('pos_week') or events.get('neg_week') or votes or sincerao_html or events.get('pos_hist') or events.get('neg_hist')) else ''}

<!-- Strategic Map -->
<div style="padding: 1rem;">
<h4 style="margin: 0 0 0.8rem 0; color: #fff; font-size: 1em; border-bottom: 1px solid #444; padding-bottom: 0.5rem;">ğŸ—ºï¸ Mapa EstratÃ©gico</h4>
''')

    if allies:
        allies_str = ', '.join(sorted(allies))
        print(f'''
<div style="margin-bottom: 0.8rem; padding: 0.6rem; background: rgba(40, 167, 69, 0.1); border-radius: 6px; border-left: 3px solid #28a745;">
<div style="font-weight: bold; color: #28a745; margin-bottom: 0.3rem;">âœ… Aliados ({n_allies})</div>
<div style="color: #ccc; font-size: 0.9em;">{allies_str}</div>
<div style="color: #6c757d; font-size: 0.8em; margin-top: 0.3rem;">â†’ Votos seguros. NÃ£o votarÃ£o contra.</div>
</div>
''')

    if enemies:
        enemy_items = [f"{e['name']} <span style='color:#888;'>({e['my_emoji']}â†”{e['their_emoji']})</span>" for e in enemies]
        enemies_str = ', '.join(enemy_items)
        print(f'''
<div style="margin-bottom: 0.8rem; padding: 0.6rem; background: rgba(220, 53, 69, 0.1); border-radius: 6px; border-left: 3px solid #dc3545;">
<div style="font-weight: bold; color: #dc3545; margin-bottom: 0.3rem;">âš”ï¸ Inimigos Declarados ({n_enemies})</div>
<div style="color: #ccc; font-size: 0.9em;">{enemies_str}</div>
<div style="color: #6c757d; font-size: 0.8em; margin-top: 0.3rem;">â†’ Hostilidade mÃºtua. Votos contra esperados de ambos os lados.</div>
</div>
''')

    if false_friends:
        ff_items = [f"<strong>{f['name']}</strong> <span style='color:#dc3545;'>({f['their_emoji']})</span>" for f in false_friends]
        ff_str = ', '.join(ff_items)
        print(f'''
<div style="margin-bottom: 0.8rem; padding: 0.6rem; background: rgba(255, 193, 7, 0.15); border-radius: 6px; border-left: 3px solid #ffc107;">
<div style="font-weight: bold; color: #ffc107; margin-bottom: 0.3rem;">âš ï¸ Falsos Amigos ({n_false_friends}) â€” PERIGO!</div>
<div style="color: #ccc; font-size: 0.9em;">{ff_str}</div>
<div style="color: #6c757d; font-size: 0.8em; margin-top: 0.3rem;">â†’ Eles dÃ£o negativa para vocÃª. Podem votar contra sem que vocÃª espere.</div>
</div>
''')

    if blind_targets:
        bt_items = [f"<strong>{b['name']}</strong> <span style='color:#28a745;'>({b['my_emoji']})</span>" for b in blind_targets]
        bt_str = ', '.join(bt_items)
        print(f'''
<div style="margin-bottom: 0.8rem; padding: 0.6rem; background: rgba(111, 66, 193, 0.1); border-radius: 6px; border-left: 3px solid #6f42c1;">
<div style="font-weight: bold; color: #6f42c1; margin-bottom: 0.3rem;">ğŸ—¡ï¸ Inimigos NÃ£o Declarados ({len(blind_targets)})</div>
<div style="color: #ccc; font-size: 0.9em;">{bt_str}</div>
<div style="color: #6c757d; font-size: 0.8em; margin-top: 0.3rem;">â†’ Eles dÃ£o â¤ï¸ para vocÃª, mas vocÃª Ã© hostil. Eles nÃ£o sabem que sÃ£o seus alvos.</div>
</div>
''')

    print('</div>')
    print('</div>')
```

---

<div class="alert alert-info" role="alert">
<strong>ğŸ’¡ Sobre este painel:</strong> Este painel acompanha as reaÃ§Ãµes do queridÃ´metro do BBB 26. As reaÃ§Ãµes <strong>mudam diariamente</strong> â€” os participantes podem trocar suas escolhas a cada Raio-X. SeÃ§Ãµes marcadas com ğŸ“¸ mostram apenas o dia mais recente; seÃ§Ãµes marcadas com ğŸ“ˆ mostram a evoluÃ§Ã£o ao longo do tempo. Acompanhamento desde 13 de janeiro de 2026.
</div>
