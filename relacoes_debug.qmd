---
title: "üß≠ Rela√ß√µes ‚Äî Debug"
subtitle: "Tally completo do score A‚ÜíB (querid√¥metro + eventos)"
---

```{python}
#| label: setup
#| message: false
#| warning: false

import json
from pathlib import Path
from collections import defaultdict
import pandas as pd
import sys

sys.path.append(str(Path("scripts").resolve()))
from data_utils import (
    require_clean_manual_events, get_all_snapshots, load_snapshot,
    build_reaction_matrix, REACTION_EMOJI, SENTIMENT_WEIGHTS, get_week_number
)

require_clean_manual_events()

RELATIONS_FILE = Path("data/derived/relations_scores.json")

relations = json.loads(RELATIONS_FILE.read_text(encoding="utf-8")) if RELATIONS_FILE.exists() else {}
relations_pairs_daily = relations.get("pairs_daily", {}) or relations.get("pairs", {})
relations_pairs_paredao = relations.get("pairs_paredao", {}) or relations.get("pairs", {})
edges_daily = relations.get("edges_daily", []) or relations.get("edges", [])
edges_paredao = relations.get("edges_paredao", []) or relations.get("edges", [])
meta = relations.get("_metadata", {})
DISPLAY_WEEK_DAILY = meta.get("effective_week_daily") or meta.get("week") or 2
DISPLAY_WEEK_PAREDAO = meta.get("effective_week_paredao") or meta.get("week") or 2
reference_date_daily = meta.get("reference_date_daily") or meta.get("date")
reference_date_paredao = meta.get("reference_date_paredao") or meta.get("date")

snapshots = get_all_snapshots()
latest = snapshots[-1] if snapshots else None
participants = []
latest_date = None
matrix_daily = {}
matrix_paredao = {}
week_snapshot_daily = None
week_snapshot_paredao = None
week_date_daily = None
week_date_paredao = None
if snapshots:
    if reference_date_daily:
        for fp, date in snapshots:
            if date <= reference_date_daily:
                week_snapshot_daily = (fp, date)
    if not week_snapshot_daily:
        for fp, date in snapshots:
            if get_week_number(date) == DISPLAY_WEEK_DAILY:
                week_snapshot_daily = (fp, date)
    if not week_snapshot_daily:
        week_snapshot_daily = latest
    if reference_date_paredao:
        for fp, date in snapshots:
            if date <= reference_date_paredao:
                week_snapshot_paredao = (fp, date)
    if not week_snapshot_paredao:
        for fp, date in snapshots:
            if get_week_number(date) == DISPLAY_WEEK_PAREDAO:
                week_snapshot_paredao = (fp, date)
    if not week_snapshot_paredao:
        week_snapshot_paredao = latest
if week_snapshot_daily:
    week_fp, week_date_daily = week_snapshot_daily
    participants, _ = load_snapshot(week_fp)
    matrix_daily = build_reaction_matrix(participants)
if week_snapshot_paredao:
    week_fp, week_date_paredao = week_snapshot_paredao
    participants, _ = load_snapshot(week_fp)
    matrix_paredao = build_reaction_matrix(participants)


def reaction_label(actor, target, matrix):
    label = matrix.get((actor, target), "")
    emoji = REACTION_EMOJI.get(label, "") if label else ""
    return label, emoji


def classify_relation(score):
    if score >= 0.5:
        return "Amig√°vel", "rel-friend"
    if score <= -0.5:
        return "Hostil", "rel-hostile"
    return "Neutro", "rel-neutral"


def fmt_score(value):
    if value is None:
        return ""
    cls = "val-zero"
    if value > 0:
        cls = "val-pos"
    elif value < 0:
        cls = "val-neg"
    return f"<span class='{cls}'>{value:.2f}</span>"


def flatten_pairs(pairs, matrix):
    rows = []
    for actor, targets in pairs.items():
        for target, rec in targets.items():
            label, emoji = reaction_label(actor, target, matrix)
            comps_week = rec.get("components_week", {})
            comps_roll = rec.get("components_roll", {})
            week_sum = rec.get("week", 0.0)
            rel_score = rec.get("roll", 0.0)
            rel_label, rel_class = classify_relation(rel_score)
            rows.append({
                "Ator": actor,
                "Alvo": target,
                "Rela√ß√£o (rolling)": f"<span class='rel-pill {rel_class}'>{rel_label}</span>",
                "Querid√¥metro": f"{emoji} {label}".strip(),
                "Power (semana)": fmt_score(comps_week.get("power_event", 0.0)),
                "Sincer√£o (semana)": fmt_score(comps_week.get("sincerao", 0.0)),
                "VIP (semana)": fmt_score(comps_week.get("vip", 0.0)),
                "Voto (semana)": fmt_score(comps_week.get("vote", 0.0)),
                "Score semana": fmt_score(week_sum),
                "Power (rolling)": fmt_score(comps_roll.get("power_event", 0.0)),
                "Sincer√£o (rolling)": fmt_score(comps_roll.get("sincerao", 0.0)),
                "VIP (rolling)": fmt_score(comps_roll.get("vip", 0.0)),
                "Voto (rolling)": fmt_score(comps_roll.get("vote", 0.0)),
                "Score rolling": fmt_score(rec.get("roll", 0.0)),
            })
    return pd.DataFrame(rows)

pairs_daily_df = flatten_pairs(relations_pairs_daily, matrix_daily) if relations_pairs_daily else pd.DataFrame()
pairs_paredao_df = flatten_pairs(relations_pairs_paredao, matrix_paredao) if relations_pairs_paredao else pd.DataFrame()

edge_rows = []
for ev in edges_paredao:
    if ev.get("week") != DISPLAY_WEEK_PAREDAO:
        continue
    weight_week = ev.get("weight_week")
    weight_roll = ev.get("weight_roll")
    edge_rows.append({
        "Data": ev.get("date"),
        "Semana": ev.get("week"),
        "Tipo": ev.get("type"),
        "Evento": ev.get("event_type") or ev.get("sinc_type"),
        "Tema": ev.get("tema"),
        "Slot": ev.get("slot"),
        "Ator": ev.get("actor"),
        "Alvo": ev.get("target"),
        "Visibilidade": ev.get("visibility"),
        "Backlash": "sim" if ev.get("backlash") else "",
        "Voto (tipo)": ev.get("vote_kind"),
        "Revelado": "sim" if ev.get("revealed") else "n√£o",
        "Peso (semana)": fmt_score(weight_week) if weight_week is not None else "",
        "Peso (rolling)": fmt_score(weight_roll) if weight_roll is not None else "",
    })

edges_df = pd.DataFrame(edge_rows)

event_rows = []
for ev in edges_paredao:
    if ev.get("week") != DISPLAY_WEEK_PAREDAO:
        continue
    if ev.get("type") == "power_event" and ev.get("event_type") not in {"indicacao", "contragolpe"}:
        continue
    if ev.get("type") != "power_event" and ev.get("type") != "vote":
        continue
    actor = ev.get("actor")
    target = ev.get("target")
    label, emoji = reaction_label(actor, target, matrix_paredao)
    event_rows.append({
        "Data": ev.get("date"),
        "Tipo": ev.get("type"),
        "Evento": ev.get("event_type"),
        "Ator": actor,
        "Alvo": target,
        "Querid√¥metro": f"{emoji} {label}".strip(),
        "Peso evento": fmt_score(ev.get("weight_raw") or 0),
        "Backlash": "sim" if ev.get("backlash") else "",
        "Voto (tipo)": ev.get("vote_kind"),
    })

events_vs_df = pd.DataFrame(event_rows)
```

## Pesos ativos

<style>
.rel-pill {
  display: inline-block;
  padding: 0.1rem 0.45rem;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
  border: 1px solid rgba(255,255,255,0.2);
}
.rel-friend { background: rgba(40,167,69,0.18); color: #a8f0b3; border-color: rgba(40,167,69,0.5); }
.rel-neutral { background: rgba(108,117,125,0.18); color: #d0d0d0; border-color: rgba(108,117,125,0.5); }
.rel-hostile { background: rgba(220,53,69,0.18); color: #ffb3bb; border-color: rgba(220,53,69,0.55); }
.val-pos { color: #8ee4a4; font-weight: 600; }
.val-neg { color: #ff9aa2; font-weight: 600; }
.val-zero { color: #d0d0d0; }
</style>

```{python}
#| label: weights
#| echo: false
#| output: asis

if meta:
    print(f"<div><strong>Semana (di√°ria):</strong> {DISPLAY_WEEK_DAILY}</div>")
    if week_date_daily:
        print(f"<div><strong>Snapshot di√°rio:</strong> {week_date_daily}</div>")
    print(f"<div><strong>Semana (pared√£o):</strong> {DISPLAY_WEEK_PAREDAO}</div>")
    if week_date_paredao:
        print(f"<div><strong>Snapshot pared√£o:</strong> {week_date_paredao}</div>")
    print(f"<div><strong>Data (√∫ltimo sync):</strong> {meta.get('date')}</div>")
    print(f"<div><strong>Semana (atual):</strong> {meta.get('week')}</div>")
    print(f"<div><strong>Semana efetiva (di√°ria):</strong> {meta.get('effective_week_daily')}</div>")
    print(f"<div><strong>Semana efetiva (pared√£o):</strong> {meta.get('effective_week_paredao')}</div>")
    print(f"<div><strong>Decay:</strong> {meta.get('weights', {}).get('decay')}</div>")
    if reference_date_daily:
        print(f"<div><strong>Querid√¥metro base (di√°rio):</strong> {reference_date_daily} (rolling 3d)</div>")
    if reference_date_paredao:
        print(f"<div><strong>Querid√¥metro base (pared√£o):</strong> {reference_date_paredao} (rolling 3d)</div>")
    print("<div style='margin-top:0.6rem;'><strong>Pesos (resumo)</strong></div>")
    print(f"<div>Querid√¥metro: {meta.get('weights', {}).get('queridometro')}</div>")
    print(f"<div>Power events: {meta.get('weights', {}).get('power_events')}</div>")
    print(f"<div>Sincer√£o: {meta.get('weights', {}).get('sincerao')}</div>")
    print(f"<div>VIP: {meta.get('weights', {}).get('vip')}</div>")
    print(f"<div>Votos: {meta.get('weights', {}).get('votes')}</div>")
    print(f"<div>Visibilidade: {meta.get('weights', {}).get('visibility_factor')}</div>")
else:
    print("<div>Sem metadados dispon√≠veis.</div>")
```

## Pares (A ‚Üí B) ‚Äî tabela completa (di√°rio)

<p class="text-muted">Tabela di√°ria usa <strong>semana {DISPLAY_WEEK_DAILY}</strong>. ‚Äú(semana)‚Äù usa apenas edges dessa semana; ‚Äú(rolling)‚Äù usa o acumulado com decay.</p>
<p class="text-muted">‚ö†Ô∏è Todos os participantes reagem uns aos outros diariamente. Aqui mostramos o <strong>emoji do dia di√°rio</strong> e o score usa rolling curto de 3 dias.</p>

```{python}
#| label: pairs-table
#| echo: false
#| output: asis

if pairs_daily_df.empty:
    print("Nenhum par encontrado.")
else:
    pairs_daily_df = pairs_daily_df.sort_values(["Ator", "Score semana"], ascending=[True, False])
    print("""
<div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin:0.6rem 0;">
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('pairsTable', 8, false)">Score semana ‚Üì</button>
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('pairsTable', 8, true)">Score semana ‚Üë</button>
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('pairsTable', 13, false)">Score rolling ‚Üì</button>
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('pairsTable', 13, true)">Score rolling ‚Üë</button>
</div>
""")
    print(pairs_daily_df.to_html(index=False, classes="table table-sm table-dark", escape=False, table_id="pairsTable"))
```

## Pares (A ‚Üí B) ‚Äî tabela completa (pared√£o)

<p class="text-muted">Tabela de pared√£o usa <strong>semana {DISPLAY_WEEK_PAREDAO}</strong> e snapshot de forma√ß√£o.</p>
<p class="text-muted">‚ö†Ô∏è Emojis refletem o dia de forma√ß√£o. Score usa rolling curto de 3 dias em torno dessa data.</p>

```{python}
#| label: pairs-table-paredao
#| echo: false
#| output: asis

if pairs_paredao_df.empty:
    print("Nenhum par encontrado.")
else:
    pairs_paredao_df = pairs_paredao_df.sort_values(["Ator", "Score semana"], ascending=[True, False])
    print("""
<div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin:0.6rem 0;">
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('pairsTableParedao', 8, false)">Score semana ‚Üì</button>
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('pairsTableParedao', 8, true)">Score semana ‚Üë</button>
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('pairsTableParedao', 13, false)">Score rolling ‚Üì</button>
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('pairsTableParedao', 13, true)">Score rolling ‚Üë</button>
</div>
""")
    print(pairs_paredao_df.to_html(index=False, classes="table table-sm table-dark", escape=False, table_id="pairsTableParedao"))
```

## Detalhes por participante (di√°rio)

```{python}
#| label: pairs-by-actor
#| echo: false
#| output: asis

if pairs_daily_df.empty:
    print("Nenhum par encontrado.")
else:
    for actor in sorted(pairs_daily_df["Ator"].unique()):
        sub = pairs_daily_df[pairs_daily_df["Ator"] == actor].copy()
        sub = sub.sort_values("Score semana", ascending=False)
        print(f"<details style='margin: 0.4rem 0;'><summary><strong>{actor}</strong></summary>")
        print(sub.to_html(index=False, classes="table table-sm table-dark", escape=False))
        print("</details>")
```

## Edges individuais (eventos e votos)

```{python}
#| label: edges-table
#| echo: false
#| output: asis

if edges_df.empty:
    print("Nenhum edge registrado.")
else:
    edges_df = edges_df.sort_values(["Semana", "Tipo", "Ator"], ascending=[False, True, True])
    print("""
<div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin:0.6rem 0;">
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('edgesTable', 12, false)">Peso semana ‚Üì</button>
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('edgesTable', 12, true)">Peso semana ‚Üë</button>
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('edgesTable', 13, false)">Peso rolling ‚Üì</button>
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('edgesTable', 13, true)">Peso rolling ‚Üë</button>
</div>
""")
    print(edges_df.to_html(index=False, classes="table table-sm table-dark", escape=False, table_id="edgesTable"))
```

<script>
function sortTable(tableId, colIndex, asc) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.rows);
  rows.sort((a, b) => {
    const getVal = (row) => {
      const cell = row.cells[colIndex];
      if (!cell) return 0;
      const text = cell.innerText.replace(',', '.').replace('%','').trim();
      const num = parseFloat(text);
      return isNaN(num) ? 0 : num;
    };
    const av = getVal(a);
    const bv = getVal(b);
    return asc ? (av - bv) : (bv - av);
  });
  rows.forEach(r => tbody.appendChild(r));
}
</script>

## Votos / Indica√ß√µes vs Querid√¥metro (semana exibida)

```{python}
#| label: events-vs-querido
#| echo: false
#| output: asis

if events_vs_df.empty:
    print("Nenhum evento/voto cr√≠tico registrado na semana.")
else:
    events_vs_df = events_vs_df.sort_values(["Tipo", "Ator"], ascending=[True, True])
    print("""
<div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin:0.6rem 0;">
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('eventsTable', 6, false)">Peso evento ‚Üì</button>
  <button class="btn btn-sm btn-outline-light" onclick="sortTable('eventsTable', 6, true)">Peso evento ‚Üë</button>
</div>
""")
    print(events_vs_df.to_html(index=False, classes="table table-sm table-dark", escape=False, table_id="eventsTable"))
```
